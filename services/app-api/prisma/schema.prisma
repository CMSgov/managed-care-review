generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model HealthPlanPackageTable {
  id        String                    @id
  stateCode String
  state     State                     @relation(fields: [stateCode], references: [stateCode])
  revisions HealthPlanRevisionTable[]
  questions Question[]
}

model ProtoMigrationsTable {
  migrationName String @id
}

model HealthPlanRevisionTable {
  id              String                 @id
  createdAt       DateTime
  pkgID           String
  formDataProto   Bytes
  submittedAt     DateTime?
  unlockedAt      DateTime?
  unlockedBy      String?
  unlockedReason  String?
  submittedBy     String?
  submittedReason String?
  pkg             HealthPlanPackageTable @relation(fields: [pkgID], references: [id])
}

model State {
  stateCode                   String                   @id
  name                        String
  latestStateSubmissionNumber Int                      @default(0)
  statePackages               HealthPlanPackageTable[]
  users                       User[]
}

model User {
  id                    String             @id
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @default(now()) @updatedAt
  givenName             String
  familyName            String
  email                 String
  role                  Role
  divisionAssignment    Division?
  stateAssignments      State[]
  stateCode             String?
  questions             Question[]
  responses             QuestionResponse[]
  audits                UserAudit[]
  updatedByAuditEntries UserAudit[]        @relation("UpdatedBy")
}

model UserAudit {
  id              String      @id @default(uuid())
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @default(now()) @updatedAt
  modifiedUserId  String      @map("userId")
  user            User        @relation(fields: [modifiedUserId], references: [id])
  updatedBy       User        @relation("UpdatedBy", fields: [updatedByUserId], references: [id])
  updatedByUserId String
  action          AuditAction
  description     String?
  priorValue      Json?
}

model Question {
  id            String                 @id
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @default(now()) @updatedAt
  pkgID         String
  pkg           HealthPlanPackageTable @relation(fields: [pkgID], references: [id])
  addedBy       User                   @relation(fields: [addedByUserID], references: [id])
  addedByUserID String
  documents     QuestionDocument[]
  responses     QuestionResponse[]
}

model QuestionDocument {
  id         String   @id
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt
  name       String
  s3URL      String
  questionID String
  question   Question @relation(fields: [questionID], references: [id])
}

model QuestionResponseDocument {
  id         String           @id
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  response   QuestionResponse @relation(fields: [responseID], references: [id])
  responseID String
  name       String
  s3URL      String
}

model QuestionResponse {
  id            String                     @id
  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt
  question      Question                   @relation(fields: [questionID], references: [id])
  addedBy       User                       @relation(fields: [addedByUserID], references: [id])
  questionID    String
  addedByUserID String
  documents     QuestionResponseDocument[]
}

enum Division {
  DMCO
  DMCP
  OACT
}

enum Role {
  CMS_USER
  STATE_USER
  ADMIN_USER
}

enum AuditAction {
  CHANGED_STATE_ASSIGNMENT
  CHANGED_DIVISION_ASSIGNMENT
}
